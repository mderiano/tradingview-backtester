<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Backtester</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>
    <div class="container">
        <header>
            <h1 id="appTitle">TradingView Backtester</h1>
            <p id="appSubtitle">Automated strategy testing with range analysis</p>
            <div class="header-actions">
                <button id="historyBtn" class="btn secondary history-btn hidden">üìú History</button>
            </div>
        </header>

        <main>
            <!-- Step 1: Indicator Selection -->
            <section class="card" id="step1">
                <h2>Select Indicator</h2>
                <!-- Discovered Indicators Container -->
                <div id="discoveredContainer" class="discovered-container hidden"></div>
            </section>

            <!-- Step 2: Configuration -->
            <section class="card hidden" id="step2">
                <div class="section-header">
                    <h2>Configure Strategy</h2>
                </div>

                <!-- Symbols Section -->
                <div class="input-group">
                    <label>Symbols</label>
                    <div class="symbols-container" id="symbolsContainer">
                        <!-- Chips injected here -->
                        <div class="add-symbol-wrapper">
                            <input type="text" id="newSymbolInput" placeholder="Add symbol..." class="add-symbol-input">
                            <button id="addSymbolBtn" class="btn-icon" title="Add Symbol">+</button>
                        </div>
                    </div>
                </div>

                <!-- Timeframes Section -->
                <div class="input-group">
                    <label>Timeframes</label>
                    <div class="timeframe-grid">
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="1">
                            1m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="3">
                            3m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="5" checked>
                            5m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="15" checked>
                            15m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="30">
                            30m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="45">
                            45m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="60" checked>
                            1h</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="120">
                            2h</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="180">
                            3h</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="240" checked>
                            4h</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="1D">
                            1D</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="1W">
                            1W</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="1M">
                            1M</label>
                    </div>
                </div>

                <!-- Date Range Section -->
                <div class="input-group">
                    <label>Backtest Date Range</label>
                    <div class="date-range-container">
                        <div class="date-input-wrapper">
                            <label for="dateFrom" class="date-label">From</label>
                            <input type="date" id="dateFrom" class="date-input">
                        </div>
                        <div class="date-separator">‚Äî</div>
                        <div class="date-input-wrapper">
                            <label for="dateTo" class="date-label">To</label>
                            <input type="date" id="dateTo" class="date-input">
                        </div>
                    </div>
                </div>

                <hr class="divider">

                <h3>Indicator Options</h3>
                <!-- Options List -->
                <div id="optionsContainer" class="options-list">
                    <!-- Dynamic options injected here -->
                </div>

                <!-- Backtest Summary -->
                <div id="backtestSummary" class="backtest-summary">
                    <div class="summary-icon">üìä</div>
                    <div class="summary-content">
                        <div class="summary-label">Total Backtests to Run:</div>
                        <div class="summary-breakdown" id="backtestBreakdown">
                            <span id="totalBacktests" class="total-count">0</span>
                            <span class="breakdown-details" id="breakdownDetails"></span>
                        </div>
                    </div>
                    <div id="accountBadge" class="account-badge hidden">
                        <span class="badge-icon">üë§</span>
                        <span class="badge-plan">-</span>
                        <span class="badge-connections">(<input type="number" id="parallelInput" min="1" max="50" value="1" title="Nombre de backtests en parall√®le"> parallel)</span>
                        <span class="badge-hint" id="badgeHint"></span>
                    </div>
                </div>

                <!-- Period Warning -->
                <div id="periodWarning" class="period-warning hidden">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-content">
                        <div class="warning-title">Long Period Warning</div>
                        <div class="warning-message" id="periodWarningMessage">-</div>
                    </div>
                </div>

                <!-- Settings Toolbar -->
                <div class="settings-toolbar" style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.02); border-radius: 8px;">
                    <button id="reloadPreviousSettingsBtn" class="btn secondary small hidden"
                        title="Reload previous settings for this indicator">üîÑ Reload</button>
                    <button id="exportSettingsBtn" class="btn secondary small" title="Export current settings to JSON file">
                        üì• Export
                    </button>
                    <button id="importSettingsBtn" class="btn secondary small" title="Import settings from JSON file">
                        üì§ Import
                    </button>
                    <input type="file" id="importSettingsFile" accept=".json" style="display: none;">
                    <button id="clearSettingsBtn" class="btn secondary small"
                        title="Clear all saved settings from localStorage">üóëÔ∏è Clear</button>
                </div>

                <!-- Main Actions -->
                <div class="actions">
                    <button id="runBacktestBtn" class="btn primary large">Run Backtest</button>
                    <button id="stopBacktestBtn" class="btn secondary large hidden">Stop Backtest</button>
                </div>
            </section>

            <!-- Step 3: Results -->
            <section class="card hidden" id="step3">
                <h2>Results</h2>

                <!-- Progress Bar -->
                <div id="progressBarContainer" class="progress-bar-container hidden">
                    <div class="progress-bar-track">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-bar-footer">
                        <span id="progressBarText" class="progress-text">0 / 0</span>
                        <span id="progressBarPercent" class="progress-percent">0%</span>
                    </div>
                </div>

                <div id="statusMessage" class="status-message"></div>

                <!-- Results Export Controls -->
                <div class="results-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div class="table-hint">üí° Click any row to view detailed analytics</div>
                    <div class="results-io-group" style="display: flex; gap: 0.5rem;">
                        <button id="exportResultsJSONBtn" class="btn secondary small">üì• Export JSON</button>
                        <button id="exportResultsExcelBtn" class="btn secondary small">üì• Export Excel</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>TF</th>
                                <th>Options</th>
                                <th>Net Profit</th>
                                <th>Trades</th>
                                <th>% Win</th>
                                <th>PF</th>
                                <th>DD</th>
                                <th>Avg Trade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Results will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Analytics Detail Modal -->
    <div id="analyticsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Strategy Analytics</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="overview">Overview</button>
                <button class="tab-btn" data-tab="performance">Performance Summary</button>
                <button class="tab-btn" data-tab="trades">List of Trades</button>
            </div>

            <div class="tab-content">
                <div id="overview-tab" class="tab-pane active">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Net Profit</div>
                            <div class="metric-value" id="modal-netProfit">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Trades</div>
                            <div class="metric-value" id="modal-totalTrades">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">% Profitable</div>
                            <div class="metric-value" id="modal-percentProfitable">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Profit Factor</div>
                            <div class="metric-value" id="modal-profitFactor">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Max Drawdown</div>
                            <div class="metric-value" id="modal-maxDrawdown">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sharpe Ratio</div>
                            <div class="metric-value" id="modal-sharpeRatio">-</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>

                <div id="performance-tab" class="tab-pane">
                    <div class="performance-grid" id="performanceDetails"></div>
                </div>

                <div id="trades-tab" class="tab-pane">
                    <div class="trades-list-container">
                        <table class="trades-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Type</th>
                                    <th>Entry Date/Time</th>
                                    <th>Entry</th>
                                    <th>Exit Date/Time</th>
                                    <th>Exit</th>
                                    <th>Profit</th>
                                    <th>Profit %</th>
                                    <th>Cumulative</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal hidden">
        <div class="modal-content history-modal-content">
            <div class="modal-header">
                <h2>Backtest History</h2>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="importResultsBtn" class="btn secondary small">üì§ Import Results</button>
                    <input type="file" id="importResultsFile" accept=".json" style="display: none;">
                    <button class="close-btn" id="closeHistoryBtn">&times;</button>
                </div>
            </div>
            <div class="history-list-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Symbols</th>
                            <th>Results</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History items injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="sync-bridge.js"></script>
    <script src="app.js"></script>
</body>

</html>