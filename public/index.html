<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Backtester</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>

<body>
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>
    <div class="container">
        <header>
            <h1 id="appTitle" data-i18n="header.title">TradingView Backtester</h1>
            <p id="appSubtitle" data-i18n="header.subtitle">Automated strategy testing with range analysis</p>
            <div class="header-actions">
                <div class="language-selector">
                    <button id="langToggle" class="btn secondary small lang-btn" title="Change language / Changer de langue">
                        <span class="lang-flag">üåê</span>
                        <span class="lang-text" id="currentLangText">EN</span>
                    </button>
                </div>
                <button id="historyBtn" class="btn secondary history-btn hidden" data-i18n="buttons.history">üìú History</button>
            </div>
        </header>

        <main>
            <!-- Step 1: Indicator Selection -->
            <section class="card" id="step1">
                <h2 data-i18n="step1.title">Select Indicator</h2>
                <!-- Discovered Indicators Container -->
                <div id="discoveredContainer" class="discovered-container hidden"></div>
            </section>

            <!-- Step 2: Configuration -->
            <section class="card hidden" id="step2">
                <div class="section-header">
                    <h2 data-i18n="step2.title">Configure Strategy</h2>
                </div>

                <!-- Symbols Section -->
                <div class="input-group">
                    <label data-i18n="step2.symbolsLabel">Symbols</label>
                    <div class="symbols-container" id="symbolsContainer">
                        <!-- Chips injected here -->
                        <div class="add-symbol-wrapper">
                            <input type="text" id="newSymbolInput" data-i18n-placeholder="placeholders.addSymbol" placeholder="Add symbol..." class="add-symbol-input">
                            <button id="addSymbolBtn" class="btn-icon" data-i18n-title="tooltips.addSymbol" title="Add Symbol">+</button>
                        </div>
                    </div>
                </div>

                <!-- Timeframes Section -->
                <div class="input-group">
                    <label data-i18n="step2.timeframesLabel">Timeframes</label>
                    <div class="timeframe-grid">
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="1">
                            1m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="3">
                            3m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="5" checked>
                            5m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="15" checked>
                            15m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="30">
                            30m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="45">
                            45m</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="60" checked>
                            1h</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="120">
                            2h</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="180">
                            3h</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="240" checked>
                            4h</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="1D">
                            1D</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="1W">
                            1W</label>
                        <label class="checkbox-label"><input type="checkbox" name="timeframe" value="1M">
                            1M</label>
                    </div>
                </div>

                <!-- Date Range Section -->
                <div class="input-group">
                    <label data-i18n="step2.dateRangeLabel">Backtest Date Range</label>
                    <div class="date-range-container">
                        <div class="date-input-wrapper">
                            <label for="dateFrom" class="date-label" data-i18n="step2.dateFrom">From</label>
                            <input type="date" id="dateFrom" class="date-input">
                        </div>
                        <div class="date-separator">‚Äî</div>
                        <div class="date-input-wrapper">
                            <label for="dateTo" class="date-label" data-i18n="step2.dateTo">To</label>
                            <input type="date" id="dateTo" class="date-input">
                        </div>
                    </div>
                </div>

                <hr class="divider">

                <h3 data-i18n="step2.indicatorOptions">Indicator Options</h3>
                <!-- Options List -->
                <div id="optionsContainer" class="options-list">
                    <!-- Dynamic options injected here -->
                </div>

                <!-- Backtest Summary -->
                <div id="backtestSummary" class="backtest-summary">
                    <div class="summary-icon">üìä</div>
                    <div class="summary-content">
                        <div class="summary-label" data-i18n="step2.backtestSummary">Total Backtests to Run:</div>
                        <div class="summary-breakdown" id="backtestBreakdown">
                            <span id="totalBacktests" class="total-count">0</span>
                            <span class="breakdown-details" id="breakdownDetails"></span>
                        </div>
                    </div>
                    <div id="accountBadge" class="account-badge hidden">
                        <span class="badge-icon">üë§</span>
                        <span class="badge-plan">-</span>
                        <span class="badge-connections">(<input type="number" id="parallelInput" min="1" max="50" value="1" data-i18n-title="tooltips.parallelConnections" title="Number of backtests in parallel"> <span data-i18n="step2.parallel">parallel</span>)</span>
                        <span class="badge-hint" id="badgeHint"></span>
                    </div>
                </div>

                <!-- Period Warning -->
                <div id="periodWarning" class="period-warning hidden">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-content">
                        <div class="warning-title" data-i18n="step2.longPeriodWarning">Long Period Warning</div>
                        <div class="warning-message" id="periodWarningMessage">-</div>
                    </div>
                </div>

                <!-- Settings Toolbar -->
                <div class="settings-toolbar" style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.02); border-radius: 8px;">
                    <button id="reloadPreviousSettingsBtn" class="btn secondary small hidden"
                        data-i18n="buttons.reload" data-i18n-title="tooltips.reloadSettings" title="Reload previous settings for this indicator">üîÑ Reload</button>
                    <button id="exportSettingsBtn" class="btn secondary small" data-i18n="buttons.export" data-i18n-title="tooltips.exportSettings" title="Export current settings to JSON file">
                        üì• Export
                    </button>
                    <button id="importSettingsBtn" class="btn secondary small" data-i18n="buttons.import" data-i18n-title="tooltips.importSettings" title="Import settings from JSON file">
                        üì§ Import
                    </button>
                    <input type="file" id="importSettingsFile" accept=".json" style="display: none;">
                    <button id="clearSettingsBtn" class="btn secondary small" data-i18n="buttons.clear"
                        data-i18n-title="tooltips.clearSettings" title="Clear all saved settings from localStorage">üóëÔ∏è Clear</button>
                </div>

                <!-- Main Actions -->
                <div class="actions">
                    <button id="runBacktestBtn" class="btn primary large" data-i18n="buttons.runBacktest">Run Backtest</button>
                    <button id="stopBacktestBtn" class="btn secondary large hidden" data-i18n="buttons.stopBacktest">Stop Backtest</button>
                </div>
            </section>

            <!-- Step 3: Results -->
            <section class="card hidden" id="step3">
                <h2 data-i18n="step3.title">Results</h2>

                <!-- Progress Bar -->
                <div id="progressBarContainer" class="progress-bar-container hidden">
                    <div class="progress-bar-track">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-bar-footer">
                        <span id="progressBarText" class="progress-text">0 / 0</span>
                        <span id="progressBarPercent" class="progress-percent">0%</span>
                    </div>
                    <div class="progress-bar-footer" id="savedProgressContainer" style="margin-top: 0.25rem; display: none;">
                        <span id="savedProgressText" class="progress-text" style="color: #4CAF50;">üíæ Sauvegard√©: 0 / 0</span>
                        <span id="savedProgressCheck" style="color: #4CAF50;">‚úì</span>
                    </div>
                </div>

                <div id="statusMessage" class="status-message"></div>

                <!-- Results Export Controls -->
                <div class="results-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div class="table-hint" data-i18n="step3.tableHint">üí° Click any row to view detailed analytics</div>
                    <div class="results-io-group" style="display: flex; gap: 0.5rem;">
                        <button id="exportResultsJSONBtn" class="btn secondary small">üì• Export</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th data-i18n="table.symbol">Symbol</th>
                                <th data-i18n="table.timeframe">TF</th>
                                <th data-i18n="table.options">Options</th>
                                <th data-i18n="table.netProfit">Net Profit</th>
                                <th data-i18n="table.trades">Trades</th>
                                <th data-i18n="table.percentWin">% Win</th>
                                <th data-i18n="table.profitFactor">PF</th>
                                <th data-i18n="table.drawdown">DD</th>
                                <th data-i18n="table.avgTrade">Avg Trade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Results will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Analytics Detail Modal -->
    <div id="analyticsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" data-i18n="modal.analyticsTitle">Strategy Analytics</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="overview" data-i18n="modal.tabs.overview">Overview</button>
                <button class="tab-btn" data-tab="performance" data-i18n="modal.tabs.performance">Performance Summary</button>
                <button class="tab-btn" data-tab="trades" data-i18n="modal.tabs.trades">List of Trades</button>
            </div>

            <div class="tab-content">
                <div id="overview-tab" class="tab-pane active">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metrics.netProfit">Net Profit</div>
                            <div class="metric-value" id="modal-netProfit">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metrics.totalTrades">Total Trades</div>
                            <div class="metric-value" id="modal-totalTrades">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metrics.percentProfitable">% Profitable</div>
                            <div class="metric-value" id="modal-percentProfitable">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metrics.profitFactor">Profit Factor</div>
                            <div class="metric-value" id="modal-profitFactor">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metrics.maxDrawdown">Max Drawdown</div>
                            <div class="metric-value" id="modal-maxDrawdown">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label" data-i18n="metrics.sharpeRatio">Sharpe Ratio</div>
                            <div class="metric-value" id="modal-sharpeRatio">-</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>

                <div id="performance-tab" class="tab-pane">
                    <div class="performance-grid" id="performanceDetails"></div>
                </div>

                <div id="trades-tab" class="tab-pane">
                    <div class="trades-list-container">
                        <table class="trades-table">
                            <thead>
                                <tr>
                                    <th data-i18n="table.number">#</th>
                                    <th data-i18n="table.type">Type</th>
                                    <th data-i18n="table.entryDateTime">Entry Date/Time</th>
                                    <th data-i18n="table.entry">Entry</th>
                                    <th data-i18n="table.exitDateTime">Exit Date/Time</th>
                                    <th data-i18n="table.exit">Exit</th>
                                    <th data-i18n="table.profit">Profit</th>
                                    <th data-i18n="table.profitPercent">Profit %</th>
                                    <th data-i18n="table.cumulative">Cumulative</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal hidden">
        <div class="modal-content history-modal-content">
            <div class="modal-header">
                <h2 data-i18n="modal.historyTitle">Backtest History</h2>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="importResultsBtn" class="btn secondary small" data-i18n="buttons.importResults">üì§ Import Results</button>
                    <input type="file" id="importResultsFile" accept=".zip" style="display: none;">
                    <button class="close-btn" id="closeHistoryBtn">&times;</button>
                </div>
            </div>
            <div class="history-list-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th data-i18n="table.date">Date</th>
                            <th data-i18n="table.status">Status</th>
                            <th data-i18n="table.symbols">Symbols</th>
                            <th data-i18n="table.results">Results</th>
                            <th data-i18n="table.actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History items injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="i18n.js"></script>
    <script src="sync-bridge.js"></script>
    <script src="app.js"></script>
</body>

</html>